parameters:
  - name: appId
    type: string
    default: ''
  - name: testSuiteId
    type: string
    default: ''
  - name: buildArtifact
    type: string
    default: ''
  - name: appFileName
    type: string
    default: ''
  - name: platform
    type: string
    default: 'not-found'
  - name: device
    type: string
    default: ''
  - name: buildApiUrl
    type: string
    default: ''

steps:
  # Archive Maestro tests
  - task: ArchiveFiles@2
    condition: ${{ eq(parameters.testSuiteId, ' ') }}
    inputs:
      rootFolderOrFile: '.maestro'
      includeRootFolder: true
      archiveType: 'zip'
      archiveFile: '$(Build.ArtifactStagingDirectory)/maestro-tests.zip'
      replaceExistingArchive: true
    displayName: 'Create ZIP-file of Maestro tests'

  # Download app build files
  - download: build
    condition: ${{ eq(parameters.appId, ' ') }}
    artifact: ${{ parameters.buildArtifact }}
    displayName: 'Download app build files'

  # Create BrowserStack Auth Hash
  - powershell: |
      $authString = "$(BROWSERSTACK_USERNAME):$(BROWSERSTACK_ACCESS_KEY)"
      $auth = [Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes($authString))
      Write-Host "##vso[task.setvariable variable=AUTH_HASH;issecret=true]$auth"
    displayName: 'Create BrowserStack Auth Hash'

  # Upload Maestro tests to BrowserStack
  - powershell: |
      if ("${{ parameters.testSuiteId }}" -ne " ") {
          Write-Host "testSuiteId is pre-filled: ${{ parameters.testSuiteId }}"
          Write-Host "##vso[task.setvariable variable=testSuiteId]${{ parameters.testSuiteId }}"
          exit 0
      }
      $headers = @{
          Authorization = "Basic $(AUTH_HASH)"
      }
      $form = @{
          file = Get-Item "$(Build.ArtifactStagingDirectory)/maestro-tests.zip"
      }
      $testSuiteResponse = Invoke-RestMethod -Uri "https://api-cloud.browserstack.com/app-automate/maestro/v2/test-suite" `
          -Method POST `
          -Headers $headers `
          -Form $form
      Write-Host "Test Suite ID: $($testSuiteResponse.test_suite_id)"
      Write-Host "##vso[task.setvariable variable=testSuiteId]$($testSuiteResponse.test_suite_id)"
    displayName: 'Upload Maestro tests to BrowserStack'

  # Upload App to BrowserStack
  - powershell: |
      if ("${{ parameters.appId }}" -ne " ") {
          Write-Host "appId is pre-filled: ${{ parameters.appId }}"
          Write-Host "##vso[task.setvariable variable=appId]${{ parameters.appId }}"
          exit 0
      }
      $appFile = Get-ChildItem "$(Pipeline.Workspace)/build/${{ parameters.buildArtifact }}/${{ parameters.appFileName }}" | Select-Object -First 1
      if (-not $appFile) {
          Write-Host "##vso[task.logissue type=error]No ${{ parameters.appFileName }} file found"
          exit 1
      }
      $headers = @{
          Authorization = "Basic $(AUTH_HASH)"
      }
      $form = @{
          custom_id = "AmsterdamAppTest-${{ parameters.platform }}"
          file = Get-Item "$(Pipeline.Workspace)/build/${{ parameters.buildArtifact }}/${{ parameters.appFileName }}"
      }
      $appResponse = Invoke-RestMethod -Uri "https://api-cloud.browserstack.com/app-automate/maestro/v2/app" `
          -Method POST `
          -Headers $headers `
          -Form $form
      Write-Host "App ID: $($appResponse.app_id)"
      Write-Host "##vso[task.setvariable variable=appId]$($appResponse.app_id)"
    displayName: 'Upload App to BrowserStack'

  # Run Maestro Tests on BrowserStack
  - powershell: |
      $buildBody = @{
          app = "bs://$(appId)"
          testSuite = "bs://$(testSuiteId)"
          project = "Amsterdam App Maestro Tests"
          devices = @("${{ parameters.device }}")
          networkLogs = $false
          deviceLogs = $true
      } | ConvertTo-Json -Depth 10
      $headers = @{
          Authorization = "Basic $(AUTH_HASH)"
          "Content-Type" = "application/json"
      }
      $buildResponse = Invoke-RestMethod -Uri "${{ parameters.buildApiUrl }}" `
          -Method POST `
          -Headers $headers `
          -Body $buildBody
      Write-Host "Build ID: $($buildResponse.build_id)"
      Write-Host "##vso[task.setvariable variable=BUILD_ID]$($buildResponse.build_id)"
    displayName: 'Run Maestro Tests on BrowserStack'

  # Wait for BrowserStack Build and Show Result
  - powershell: |
      $buildId = "$(BUILD_ID)"
      $url = "https://api-cloud.browserstack.com/app-automate/maestro/v2/builds/$buildId"
      Write-Host "Build status URL: $url"
      Write-Host "View progress in BrowserStack: https://app-automate.browserstack.com/dashboard/v2/builds/$buildId"
      $headers = @{
          Authorization = "Basic $(AUTH_HASH)"
      }
      $status = "running"
      $attempt = 0
      $maxAttempts = 60
      $waitSeconds = 10
      Write-Host "Polling BrowserStack build status for build ID: $buildId"
      while ($status -eq "running" -and $attempt -lt $maxAttempts) {
          $response = Invoke-RestMethod -Uri $url -Headers $headers
          $status = $response.status
          Write-Host "Attempt $($attempt + 1): Status = $status"
          if ($status -eq "running") {
              Start-Sleep -Seconds $waitSeconds
              $attempt++
          }
      }
      if ($status -eq "running") {
          Write-Host "##vso[task.logissue type=error]Timed out waiting for build to finish."
          exit 1
      }
      Write-Host "Final build status: $status"
      Write-Host "View build result in BrowserStack: https://app-automate.browserstack.com/dashboard/v2/builds/$buildId"
      Write-Host "Full response:"
      $response | ConvertTo-Json -Depth 10
      if ($status -ne "passed") {
          Write-Host "##vso[task.logissue type=error]Build did not pass. Status: $status"
          exit 1
      }
    displayName: 'Wait for BrowserStack Build and Show Result'
